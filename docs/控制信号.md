# 控制信号

## 控制信号

在此次五级流水线中，我们对采用异步的方式对内存进行读写，并假设没有延迟。

整个流水线中，将会使用到以下控制信号：

- `imm_type`：立即数扩展类型信号。立即数扩展单元将根据该信号对指令中的立即数进行扩展。
- `rs1_tag`：`rs1`有效信号。用于告诉冒险模块是否考虑`rs1`的冒险。
- `rs2_tag`：`rs2`有效信号。用于告诉冒险模块是否考虑`rs2`的冒险。
- `a_ctl`：选择器A的选择信号。在执行阶段时，选择器A将根据该信号对输入数据`src1`进行选择。
- `b_ctl`：选择器B的选择信号。在执行阶段时，选择器B将根据该信号对输入数据`src2`进行选择。
- `alu_ctl`：算术逻辑单元控制信号。算术逻辑单元根据该信号决定对两个源操作数执行那种类型的运算或者是规定运算位数。
- `mul_ctl`：乘除法器控制信号。乘除法器根据该信号决定对两个源操作数执行那种类型的运算或者是规定运算位数。
- `exe_out_ctl`：执行阶段输出的控制信号。执行阶段根据该信号决定是输出乘除法器的运算结果，还是算术运算单元输出的结果。
- `dnpc_ctl`：跳转`PC`的源操作数一的选择信号。决定跳转指令的第一操作数是`PC`还是`src1`。
- `mem_ctl`：内存控制信号。控制内存的读写行为。
- `reg_w_en`：寄存器写使能信号。决定是否要对寄存器堆进行写操作。
- `wb_ctl`：写回控制信号。选择准备写往寄存器堆的数据。
- `ebreak_op`：`ebreak`指令信号。用于控制仿真环境结束运行。
- `invalid_op`：非法指令信号。用于告诉仿真环境遇到错误指令并抛出异常。

在冒险模块中，会使用到以下控制信号：

- `fa_ctl`：转发器A的选择信号。决定选择那一个转发数据作为源操作数1，或者不选择转发数据。
- `fb_ctl`：转发器B的选择信号。决定选择那一个转发数据作为源操作数2，或者不选择转发数据。

------

每个控制信号的具体设计如下：

### `imm_type`：

决定立即数扩展单元将要扩展的立即数的格式。

位宽：3位

比特图：

```
 2        0
+----------+
| imm_type |
+----------+
```

含义：

| 数值     | 描述        |
| -------- | ----------- |
| "b000".U | R类型立即数 |
| "b001".U | I类型立即数 |
| "b010".U | S类型立即数 |
| "b011".U | B类型立即数 |
| "b100".U | U类型立即数 |
| "b101".U | J类型立即数 |
| "b110".U | 保留使用    |
| "b111".U | 保留使用    |

### `rs1_tag`

`rs1`是否有效的信号。

位宽：1位

比特图：

```
 0       0
+---------+
| rs1_tag |
+---------+
```

含义：

| 数值    | 描述 |
| ------- | ---- |
| false.B | 无效 |
| true.B  | 有效 |

### `rs2_tag`

`rs2`是否有效的信号。

位宽：1位

比特图：

```
 0       0
+---------+
| rs2_tag |
+---------+
```

含义：

| 数值    | 描述 |
| ------- | ---- |
| false.B | 无效 |
| true.B  | 有效 |

### `a_ctl`

决定选择器A对那个数据进行选择。

位宽：1位

比特图：

```
 0                 0
+-------------------+
| selector A target |
+-------------------+
```

含义：

| 数值    | 描述                |
| ------- | ------------------- |
| false.B | `src1`作为源操作数1 |
| true.B  | `pc`作为源操作数1   |

### `b_ctl`

决定选择器B对那个数据进行选择。

位宽：1位

比特图：

```
  0                0
+-------------------+
| selector B target |
+-------------------+
```

含义：

| 数值    | 描述                |
| ------- | ------------------- |
| false.B | `src2`作为源操作数2 |
| true.B  | `imm`作为源操作数2  |

### `dnpc_ctl`

控制跳转`PC`的源操作数1是原`PC`还是`src2`。

位宽：1位

比特图：

```
 0                      0
+------------------------+
| target PC select value |
+------------------------+
```

含义：

| 数值    | 描述                          |
| ------- | ----------------------------- |
| false.B | `PC`作为跳转`PC`的源操作数1   |
| true.B  | `src2`作为跳转`PC`的源操作数1 |

### `alu_ctl`

控制算术逻辑单元正确使用两个源操作数进行相应的计算得出需要的结果。

位宽：5位

比特图：

```
 4       4 3           0
+---------+-------------+
| word_op | alu_op_code |
+---------+-------------+
```

含义：

`word_op`

| 数值   | 描述     |
| ------ | -------- |
| "b0".U | 非字运算 |
| "b1".U | 字运算   |

`alu_op_code`

| 数值      | 描述           |
| --------- | -------------- |
| "b0000".U | 加法运算       |
| "b0001".U | 减法运算       |
| "b0010".U | 异或运算       |
| "b0011".U | 或运算         |
| "b0100".U | 与运算         |
| "b0101".U | 有符号小于     |
| "b0110".U | 有符号大于等于 |
| "b0111".U | 小于           |
| "b1000".U | 大于等于       |
| "b1001".U | 等于           |
| "b1010".U | 不等于         |
| "b1011".U | 左移           |
| "b1100".U | 逻辑右移       |
| "b1101".U | 算术右移       |
| "b1110".U | 直传A          |
| "b1111".U | 直传B          |

### `mul_ctl`

乘除法器的控制信号。

位宽：4位

比特图：

```
 3       3 2              0
+---------+----------------+
| word op | operation code |
+---------+----------------+
```

含义：

`word op`

| 数值   | 描述     |
| ------ | -------- |
| "b0".U | 非字运算 |
| "b1".U | 字运算   |

`operation code`

| 数值     | 描述                         |
| -------- | ---------------------------- |
| "b000".U | 有符号乘法指令，获取低64位   |
| "b001".U | 有符号乘法指令，获取高64位   |
| "b010".U | 有符号乘以无符号，获取高64位 |
| "b011".U | 无符号乘以无符号，获取高64位 |
| "b100".U | 有符号除以有符号             |
| "b101".U | 无符号除以无符号             |
| "b110".U | 有符号除以有符号的余数       |
| "b111".U | 无符号除以无符号的余数       |

### `exe_out_ctl`

执行阶段的输出控制信号。

位宽：1位

比特图：

```
 0                   0
+---------------------+
| execute out control |
+---------------------+
```

含义：

| 数值    | 描述                                     |
| ------- | ---------------------------------------- |
| false.B | 选择算术运算单元的结果作为执行阶段的输出 |
| true.B  | 选择乘除法器运算的结果作为执行阶段的输出 |

### `jump_op`

跳转指令类型信号。

位宽：2位

比特图:

```
 1                        1 0                          0
+--------------------------+----------------------------+
| is_conditional_jump_inst | is_unconditional_jump_inst |
+--------------------------+----------------------------+
```

含义：

| 数值    | 描述           |
| ------- | -------------- |
| "b00".U | 非跳转指令     |
| "b01".U | 无条件跳转指令 |
| "b10".U | 有条件跳转指令 |
| "b11".U | 无意义         |

### `mem_ctl`

控制内存读写的字节数

位宽：5位

比特图：

```
 4            4 3           3 2      2 1       0
+--------------+-------------+--------+---------+
| write enable | read enable | extend | op code |
+--------------+-------------+--------+---------+
```

含义：

`write enable`

| 数值    | 描述       |
| ------- | ---------- |
| true.B  | 内存写操作 |
| false.B | 无写操作   |

`read enable`

| 数值    | 描述       |
| ------- | ---------- |
| true.B  | 内存读操作 |
| false.B | 无读操作   |

`extend`

| 数值    | 描述           |
| ------- | -------------- |
| true.B  | 不需要符号扩展 |
| false.B | 需要符号扩展   |

`op code`

| 数值    | 描述     |
| ------- | -------- |
| “b00”.U | 字节操作 |
| "b01".U | 半字操作 |
| "b10".U | 字操作   |
| "b11".U | 双字操作 |

### `reg_w_en`

寄存器写使能信号。

位宽：1位

比特图：

```
 0                   0
+---------------------+
| memory write enable |
+---------------------+
```

含义：

| 数值    | 描述           |
| ------- | -------------- |
| false.B | 不能写入寄存器 |
| true.B  | 可以写入寄存器 |

### `wb_ctl`

控制即将写入寄存器堆的数值。

位宽：2位

比特图：

```
 1                       0
+-------------------------+
| write back data control |
+-------------------------+
```

含义：

| 数值   | 描述                                     |
| ------ | ---------------------------------------- |
| "00".U | 以算术逻辑单元输出的值作为输入寄存器的值 |
| "01".U | 以内存读取的值作为寄存器输入的值         |
| "10".U | 以静态下一跳的`PC`值作为寄存器输入的值   |
| "11".U | 保留使用                                 |

### `ebreak_op`

`ebreak`指令信号，控制仿真环境结束运行。

位宽：1位

比特图：

```
 0         0
+-----------+
| is_ebreak |
+-----------+
```

含义：

| 数值    | 描述           |
| ------- | -------------- |
| false.B | 非`ebreak`指令 |
| true.B  | `ebreak`指令   |

### `valid_op`

非法指令的信号，控制仿真环境结束运行并抛出异常。

位宽：1位

比特图：

```
 0        0
+----------+
| is_valid |
+----------+
```

含义：

| 数值    | 描述     |
| ------- | -------- |
| false.B | 合法指令 |
| true.B  | 非法指令 |

### `fa_ctl`

选择将哪一个转发数据作为源操作数1。

位宽：3位

比特图：

```
 2      0
+--------+
| fa_ctl |
+--------+
```

含义：

| 数值     | 描述                                             |
| -------- | ------------------------------------------------ |
| "b000".U | 不使用转发数据，直接使用寄存器读取的数据         |
| "b001".U | 选择执行阶段的算术逻辑单元的输出结果作为转发数据 |
| "b010".U | 选择执行阶段的静态下一跳的数据作为转发数据       |
| "b011".U | 选择访存阶段的算术逻辑单元的输出结果作为转发数据 |
| "b100".U | 选择访存阶段的内存读取结果作为转发数据           |
| "b101".U | 选择访存阶段的静态下一跳的数据作为转发数据       |
| "b110".U | 选择写回阶段的写回数据作为转发数据               |
| "b111".U | 保留使用                                         |

### `fb_ctl`

选择将哪一个转发数据作为源操作数2。

位宽：3位

比特图：

```
 2      0
+--------+
| fb_ctl |
+--------+
```

含义：

| 数值     | 描述                                             |
| -------- | ------------------------------------------------ |
| "b000".U | 不使用转发数据，直接使用寄存器读取的数据         |
| "b001".U | 选择执行阶段的算术逻辑单元的输出结果作为转发数据 |
| "b010".U | 选择执行阶段的静态下一跳的数据作为转发数据       |
| "b011".U | 选择访存阶段的算术逻辑单元的输出结果作为转发数据 |
| "b100".U | 选择访存阶段的内存读取结果作为转发数据           |
| "b101".U | 选择访存阶段的静态下一跳的数据作为转发数据       |
| "b110".U | 选择写回阶段的写回数据作为转发数据               |
| "b111".U | 保留使用                                         |

## 控制信号常量

### `imm_type`

- `IMM_TYPE_DEFAULT`："b000".U

- `IMM_TYPE_R`："b000".U
- `IMM_TYPE_I`："b001".U
- `IMM_TYPE_S`："b010".U
- `IMM_TYEP_B`："b011".U
- `IMM_TYPE_U`："b100".U
- `IMM_TYPE_J`："b101".U

### `rs1_tag`

- `RS1_VALID`：true.B
- `RS1_INVALID`：false.B

### `rs2_tag`

- `RS2_VALID`：true.B
- `RS2_INVALID`：false.B

### `a_ctl`

- `A_CTL_DEFALUT`：false.B

- `A_CTL_SRC1`：false.B
- `A_CTL_PC`：true.B

### `b_ctl`

- `B_CTL_DEFAULT`：false.B

- `B_CTL_IMM`：false.B
- `B_CTL_SRC2`：true.B

### `dnpc_ctl`

- `DNPC_CTL_DEFAULT`：false.B
- `DNPC_CTL_PC`：false.B
- `DNPC_CTL_SRC`：true.B

### `alu_ctl`

- `ALU_CTL_DEFAULT`："b00000".U
- `ALU_CTL_ADD`："b00000".U
- `ALU_CTL_ADDW`："b10000".U
- `ALU_CTL_SUB`："b00001".U
- `ALU_CTL_SUBW`："b10001".U
- `ALU_CTL_XOR`："b00010".U
- `ALU_CTL_OR`："b00011".U
- `ALU_CTL_AND`："b00100".U
- `ALU_CTL_SLT`："b00101".U
- `ALU_CTL_SGE`："b00110".U
- `ALU_CTL_SLTU`："b00111".U
- `ALU_CTL_SGEU`："b01000".U
- `ALU_CTL_EQU`："b01001".U
- `ALU_CTL_NEQ`："b01010".U
- `ALU_CTL_SLL`："b01011".U
- `ALU_CTL_SLLW`："b11011".U
- `ALU_CTL_SRL`："b01100".U
- `ALU_CTL_SRLW`："b11100".U
- `ALU_CTL_SRA`："b01101".U
- `ALU_CTL_SRAW`："b11101".U
- `ALU_CTL_MOVA`："b01110".U
- `ALU_CTL_MOVB`："b01111".U

### `mul_ctl`

- `MUL_CTL_DEFAULT`："b0000".U
- `MUL_CTL_MUL`："b0000".U
- `MUL_CTL_MULW`："b1000".U
- `MUL_CTL_MULH`："b0001".U
- `MUL_CTL_MULHSU`："b0010".U
- `MUL_CTL_MULHU`："b0011".U
- `MUL_CTL_DIV`："b0100".U
- `MUL_CTL_DIVW`："b1100".U
- `MUL_CTL_DIVU`："b0101".U
- `MUL_CTL_DIVUW`："b1101".U
- `MUL_CTL_REM`："b0110".U
- `MUL_CTL_REMW`："b1110".U
- `MUL_CTL_REMU`："b0111".U
- `MUL_CTL_REMUW`："b1111".U

### `exe_out_ctl`

- `EXE_OUT_DEFAULT`：false.B
- `EXE_OUT_ALU`：false.B
- `EXE_OUT_MUL`：true.B

### `jump_op`

- `JUMP_OP_DEFAULT`："b00".U
- `JUMP_OP_JAL`："b01".U
- `JUMP_OP_BRANCH`："b10".U

### `mem_ctl`

- `MEM_CTL_DEFAULT`："b00000".U
- `MEM_CTL_LB`："b01000".U
- `MEM_CTL_LH`："b01001".U
- `MEM_CTL_LW`："b01010".U
- `MEM_CTL_LD`："b01011".U
- `MEM_CTL_LBU`："b01100".U
- `MEM_CTL_LHU`："b01101".U
- `MEM_CTL_LWU`："b01110".U
- `MEM_CTL_SB`："b10000".U
- `MEM_CTL_SH`："b10001".U
- `MEM_CTL_SW`："b10010".U
- `MEM_CTL_SD`："b10011".U

### `reg_w_en`

- `REG_W_ENABLE`：true.B
- `REG_W_DISABLE`：false.B

### `wb_ctl`

- `WB_CTL_DEFAULT`："b00".U
- `WB_CTL_ALU`："b00".U
- `WB_CTL_MEM`："b01".U
- `WB_CTL_SNPC`："b10".U

### `ebreak_op`

- `EBREAK_OP_YES`：true.B
- `EBREAK_OP_NO`：false.B

### `invalid_op`

- `INVALID_OP_YES`：true.B
- `INVALID_OP_NO`：false.B

### `f_ctl`

转发器A和B通用。

- `F_CTL_DEFAULT`："b000".U
- `F_CTL_ALU_OUT_E`："b001".U
- `F_CTL_SNPC_E`："b010".U
- `F_CTL_ALU_OUT_M`："b011".U
- `F_CTL_MEM_OUT_M`："b100".U
- `F_CTL_SNPC_M`："b101".U
- `F_CTL_WB_DATA`："b110".U

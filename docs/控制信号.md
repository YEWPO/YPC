# 控制信号

## 控制信号

在此次五级流水线中，我们对采用异步的方式对内存进行读写，并假设没有延迟。

整个流水线中，将会使用到以下控制信号：

- `imm_tp`：立即数扩展类型信号。立即数扩展单元将根据该信号对指令中的立即数进行扩展。
- `a_choice`：选择器A的选择信号。在执行阶段时，选择器A将根据该信号对输入数据`src1`进行选择。
- `b_choice`：选择器B的选择信号。在执行阶段时，选择器B将根据该信号对输入数据`src2`进行选择。
- `ALU_ctl`：算术逻辑单元控制信号。算术逻辑单元根据该信号决定对两个源操作数执行那种类型的运算或者是规定运算位数。
- `target_PC_ctl`：跳转`PC`的源操作数一的选择信号。决定跳转指令的第一操作数是`PC`还是`src1`。
- `jump_inst`：无条件跳转指令信号。
- `branch_inst`：分支跳转指令信号。
- `mem_w_en`：内存写使能信号。决定是否进行内存的写操作。
- `reg_w_en`：寄存器写使能信号。决定是否要对寄存器堆进行写操作。
- `wb_ctl`：写回控制信号。选择准备写往寄存器堆的数据。

------

每个控制信号的具体设计如下：

### `imm_tp`：

决定立即数扩展单元将要扩展的立即数的格式。

位宽：3位

比特图：

```
 2       0
+----------+
| imm_type |
+----------+
```

含义：

| 数值    | 描述        |
| ------- | ----------- |
| "000".U | R类型立即数 |
| "001".U | I类型立即数 |
| "010".U | S类型立即数 |
| "011".U | B类型立即数 |
| "100".U | U类型立即数 |
| "101".U | J类型立即数 |
| "110".U | 保留使用    |
| "111".U | 非法指令    |

如果为非法指令，将会终止整个仿真环境的运行。

### `a_choice`

决定选择器A对那个数据进行选择。

位宽：1位

比特图：

```
  0                0
+-------------------+
| selector A target |
+-------------------+
```

含义：

| 数值    | 描述                |
| ------- | ------------------- |
| false.B | `src1`作为源操作数1 |
| true.B  | `pc`作为源操作数1   |

### `b_choice`

决定选择器B对那个数据进行选择。

位宽：1位

比特图：

```
  0                0
+-------------------+
| selector B target |
+-------------------+
```

含义：

| 数值    | 描述                |
| ------- | ------------------- |
| false.B | `src2`作为源操作数2 |
| true.B  | `imm`作为源操作数2  |

### `target_PC_ctl`

控制跳转`PC`的源操作数1是原`PC`还是`src2`。

位宽：1位

比特图：

```
 0                      0
+------------------------+
| target PC select value |
+------------------------+
```

含义：

| 数值    | 描述                          |
| ------- | ----------------------------- |
| false.B | `PC`作为跳转`PC`的源操作数1   |
| true.B  | `src2`作为跳转`PC`的源操作数1 |

### `ALU_ctl`

控制算术逻辑单元正确使用两个源操作数进行相应的计算得出需要的结果。

位宽：5位

比特图：

```
 4                4  3        3 2      0
+-------------------+----------+--------+
| word opration bit | funct7_5 | funct3 |
+-------------------+----------+--------+
```

含义：

| 数值(funct3) | 描述       |
| ------------ | ---------- |
| "000".U      | 加法       |
| "001".U      | 左移       |
| "010".U      | 有符号小于 |
| "011".U      | 无符号小于 |
| "100".U      | 异或       |
| "101".U      | 逻辑右移   |
| "110".U      | 或         |
| "111".U      | 与         |

| 数值(funct7_5) | 描述                                                         |
| -------------- | ------------------------------------------------------------ |
| false.B        | 对于加法和右移运算保持原运算结果                             |
| true.B         | 对加法和右移运算有效。加法变为减法运算，逻辑右移变为算术右移运算。 |

| 数值    | 描述             |
| ------- | ---------------- |
| false.B | 执行64位算术运算 |
| true.B  | 执行32位算术运算 |

### `jump_inst`

无条件跳转指令信号。

位宽：1位

比特图:

```
 0            0
+--------------+
| is_jump_inst |
+--------------+
```

含义：

| 数值    | 描述             |
| ------- | ---------------- |
| false.B | 非无条件跳转指令 |
| true.B  | 为无条件跳转指令 |

### `branch_inst`

无条件跳转指令信号。

位宽：1位

比特图:

```
 0             0
+---------------+
| is_brach_inst |
+---------------+
```

含义：

| 数值    | 描述           |
| ------- | -------------- |
| false.B | 非分支跳转指令 |
| true.B  | 为分支跳转指令 |

### `mem_w_en`

内存写使能信号。

位宽：1位

比特图：

```
  0                  0
+---------------------+
| memory write enable |
+---------------------+
```

含义：

| 数值    | 描述         |
| ------- | ------------ |
| false.B | 不能写入内存 |
| true.B  | 可以写入内存 |

### `reg_w_en`

寄存器写使能信号。

位宽：1位

比特图：

```
 0                   0
+---------------------+
| memory write enable |
+---------------------+
```

含义：

| 数值    | 描述           |
| ------- | -------------- |
| false.B | 不能写入寄存器 |
| true.B  | 可以写入寄存器 |

### `wb_ctl`

控制即将写入寄存器堆的数值。

位宽：2位

比特图：

```
 1                       0
+-------------------------+
| write back data control |
+-------------------------+
```

含义：

| 数值   | 描述                                     |
| ------ | ---------------------------------------- |
| "00".U | 以算术逻辑单元输出的值作为输入寄存器的值 |
| "01".U | 以内存读取的值作为寄存器输入的值         |
| "10".U | 以静态下一跳的`PC`值作为寄存器输入的值   |
| "11".U | 保留使用                                 |

## RISCV32I

### U type

| 指令  | `imm_tp` | `a_choice` | `b_choice` | `target_PC_ctl` | `jump_inst` | `brach_inst` | `ALU_ctl` | `mem_w_en` | `reg_w_en` | `wb_ctl` |
| ----- | -------- | ---------- | ---------- | --------------- | ----------- | ------------ | --------- | ---------- | ---------- | -------- |
| lui   | "100".U  |            |            |                 |             |              |           |            |            |          |
| auipc | "100".U  |            |            |                 |             |              |           |            |            |          |

